<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Uniform Stock Manager</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
  body {
    font-family: 'Roboto', sans-serif;
    margin:0; padding:0;
    background: linear-gradient(120deg,#89f7fe,#66a6ff);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
    color:#333;
  }
  @keyframes gradientBG{
    0%{background-position:0% 50%}
    50%{background-position:100% 50%}
    100%{background-position:0% 50%}
  }
  header {
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 20px; background:rgba(255,255,255,0.8); backdrop-filter:blur(5px);
  }
  header img {
    height:70px; width:auto;
    animation: breathe 3s ease-in-out infinite alternate;
  }
  @keyframes breathe{
    0%{transform:scale(1);}
    50%{transform:scale(1.08);}
    100%{transform:scale(1);}
  }
  header h1 { font-size:28px; margin:0; flex:1; text-align:center;}
  button { padding:6px 12px; margin:3px; cursor:pointer; border:none; border-radius:5px; background:#66a6ff; color:#fff; font-weight:bold; }
  button:hover { background:#89f7fe; color:#000; }
  section { background:rgba(255,255,255,0.95); margin:20px; padding:20px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.2);}
  table { width:100%; border-collapse:collapse; margin-top:15px; }
  th,td { border:1px solid #aaa; padding:8px; text-align:center; }
  input, select { width:100%; padding:6px; margin-top:5px; box-sizing:border-box; }
  input[readonly] { background:#eee; }
  form div { margin-bottom:10px; }
  .hidden { display:none; }
  .rtl { direction:rtl; text-align:right; }
</style>
</head>
<body>

<header>
  <img src="https://i.ibb.co/N0Bdr5N/Care-Pro-Logo-Jan-2025-Transparent.png" alt="Logo">
  <h1 id="title">Uniform Stock Manager</h1>
  <button onclick="toggleLang()">English / العربية</button>
</header>

<section id="stockSection">
  <h2 id="stockTitle">Stock</h2>
  <button onclick="exportStock()">Export Full Stock</button>
  <table id="stockTable">
    <thead>
      <tr>
        <th>Item</th>
        <th>Size</th>
        <th>Available Qty</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section id="loginSection">
  <h2 id="loginTitle">Login</h2>
  <div id="loginDiv">
    <div><input type="text" id="userId" placeholder="User ID"></div>
    <div><input type="password" id="password" placeholder="Password"></div>
    <button onclick="login()">Login</button>
  </div>
</section>

<section id="mainApp" class="hidden">
  <h2 id="entryTitle">Delivery / Return Entry</h2>
  <button onclick="exportReport()">Export Delivery Report</button>
  <form id="entryForm">
    <div><input type="text" id="iqama" placeholder="Iqama" required></div>
    <div><input type="text" id="emp" placeholder="Employee Name" required></div>
    <div><input type="date" id="date" required></div>
    <div>
      <select id="item"></select>
      <select id="size"></select>
    </div>
    <div><input type="number" id="qty" placeholder="Quantity" required min="1"></div>
    <div><input type="text" id="client" placeholder="Client"></div>
    <div><input type="text" id="note" placeholder="Note"></div>
    <button type="submit">Add Entry</button>
  </form>

  <h2 id="transTitle">Transactions</h2>
  <table id="transTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Iqama</th>
        <th>Name</th>
        <th>Date</th>
        <th>Item</th>
        <th>Size</th>
        <th>Qty</th>
        <th>Client</th>
        <th>Note</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
let lang='en';
const BASE = 'https://your-vercel-deployment.vercel.app/api'; // Replace with your Vercel URL
const USERS = [{id:'admin', password:'1234'}];

let stockData = [];
let transactions = [];

// Toggle language
function toggleLang(){
  lang = lang==='en'?'ar':'en';
  document.body.className = lang==='ar'?'rtl':'';
  document.getElementById('title').innerText = lang==='en'?'Uniform Stock Manager':'إدارة المخزون';
  document.getElementById('stockTitle').innerText = lang==='en'?'Stock':'المخزون';
  document.getElementById('loginTitle').innerText = lang==='en'?'Login':'تسجيل الدخول';
  document.getElementById('entryTitle').innerText = lang==='en'?'Delivery / Return Entry':'تسليم / إرجاع';
  document.getElementById('transTitle').innerText = lang==='en'?'Transactions':'المعاملات';
}

// Login
async function login(){
  const id = document.getElementById('userId').value;
  const pass = document.getElementById('password').value;
  const res = await fetch(BASE+'/login',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id,password})});
  const data = await res.json();
  if(data.success){
    document.getElementById('loginSection').style.display='none';
    document.getElementById('mainApp').classList.remove('hidden');
    await loadStock();
    await loadTransactions();
    setupEntryForm();
  } else alert(lang==='en'?'Invalid credentials':'بيانات الدخول غير صحيحة');
}

// Load stock
async function loadStock(){
  const res = await fetch(BASE+'/stock');
  stockData = await res.json();
  renderStock();
}

// Render stock table
function renderStock(){
  const tbody = document.querySelector('#stockTable tbody');
  tbody.innerHTML='';
  const itemSelect = document.getElementById('item');
  const sizeSelect = document.getElementById('size');
  itemSelect.innerHTML=''; sizeSelect.innerHTML='';
  stockData.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${r.Item}</td><td>${r.Size}</td><td><input type="number" value="${r.Quantity}" readonly></td>`;
    tbody.appendChild(tr);
    if(![...itemSelect.options].some(o=>o.value===r.Item)) itemSelect.innerHTML += `<option>${r.Item}</option>`;
  });
}

// Load transactions
async function loadTransactions(){
  const res = await fetch(BASE+'/transactions');
  transactions = await res.json();
  renderTransactions();
}

// Render transactions
function renderTransactions(){
  const tbody = document.querySelector('#transTable tbody');
  tbody.innerHTML='';
  transactions.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${t.id}</td><td>${t.iqama}</td><td>${t.emp}</td><td>${t.date}</td><td>${t.item}</td><td>${t.size}</td><td>${t.qty}</td><td>${t.client}</td><td>${t.note}</td>
    <td><button onclick="deleteTrans('${t.id}')">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

// Setup Entry Form
function setupEntryForm(){
  const form = document.getElementById('entryForm');
  const sizeSelect = document.getElementById('size');
  const itemSelect = document.getElementById('item');
  itemSelect.addEventListener('change', updateSizes);
  updateSizes();
  form.onsubmit = async (e)=>{
    e.preventDefault();
    const entry = {
      id: Date.now().toString(),
      iqama: document.getElementById('iqama').value,
      emp: document.getElementById('emp').value,
      date: document.getElementById('date').value,
      item: itemSelect.value,
      size: sizeSelect.value,
      qty: parseInt(document.getElementById('qty').value),
      client: document.getElementById('client').value,
      note: document.getElementById('note').value
    };
    const stockRow = stockData.find(r=>r.Item===entry.item && r.Size===entry.size);
    if(!stockRow || stockRow.Quantity<entry.qty){ alert(lang==='en'?'Not enough stock':'الكمية غير كافية'); return; }
    stockRow.Quantity -= entry.qty;
    await fetch(BASE+'/stock',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(stockData)});
    await fetch(BASE+'/transactions',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(entry)});
    await loadStock(); await loadTransactions();
    e.target.reset();
  }
}

// Update size options based on selected item
function updateSizes(){
  const item = document.getElementById('item').value;
  const sizes = stockData.filter(r=>r.Item===item).map(r=>r.Size);
  const sizeSelect = document.getElementById('size');
  sizeSelect.innerHTML = '';
  sizes.forEach(s=>{ sizeSelect.innerHTML += `<option>${s}</option>`; });
}

// Delete transaction
async function deleteTrans(id){
  await fetch(BASE+'/transactions/'+id,{method:'DELETE'});
  await loadStock(); await loadTransactions();
}

// Export full stock
function exportStock(){
  let csv='Item,Size,Quantity\n';
  stockData.forEach(r=>{ csv+=`${r.Item},${r.Size},${r.Quantity}\n`; });
  downloadCSV(csv,'full_stock.csv');
}

// Export delivery report
function exportReport(){
  let csv='Iqama,Name,Date,Item,Size,Qty,Client,Note\n';
  transactions.forEach(t=>{ csv+=`${t.iqama},${t.emp},${t.date},${t.item},${t.size},${t.qty},${t.client},${t.note}\n`; });
  downloadCSV(csv,'delivery_report.csv');
}

// CSV download helper
function downloadCSV(csv, filename){
  const blob = new Blob([csv], {type:'text/csv'});
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download=filename;
  a.click();
  window.URL.revokeObjectURL(url);
}

// Initial load (stock only, read-only)
loadStock();
</script>
</body>
</html>
